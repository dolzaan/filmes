<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Onde assistir meu filme?</title>
  <link rel="icon" type="image/x-icon" href="claquete.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<!-- Vercel Analytics -->
<script defer src="/_vercel/insights/script.js"></script>

<body class="flex flex-col min-h-screen bg-gradient-to-r from-purple-300 via-purple-200 to-pink-200">

  <!-- Container principal -->
  <div id="mainContainer" class="flex flex-col items-center justify-center flex-grow transition-all duration-700 ease-in-out px-4">

    <!-- Texto animado responsivo -->
    <div id="dynamicText" class="mb-4 text-xl sm:text-2xl md:text-4xl font-semibold text-gray-700 h-12 text-center leading-tight break-words"></div>
    
    <!-- Caixa de input -->
    <div class="relative w-full max-w-md mb-6">
      <input
        id="movieInput"
        type="text"
        placeholder="O que você quer assistir hoje?"
        class="w-full px-5 py-3 pr-20 rounded-full border border-gray-300 shadow-sm text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
      />
      <button
        id="searchBtn"
        class="absolute right-3 top-1/2 -translate-y-1/2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-1 rounded-full shadow-sm focus:outline-none"
      >
        Buscar
      </button>
    </div>

    <!-- Resultados -->
    <div id="results" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 hidden"></div>

  </div>

  <script>
    const isLocal = ["localhost", "127.0.0.1"].includes(window.location.hostname);
    const API_BASE = isLocal
      ? "http://localhost:3000"
      : "https://onde-assistir-meu-filme.vercel.app";

    const mainContainer = document.getElementById("mainContainer");
    const resultsDiv = document.getElementById("results");
    const searchBtn = document.getElementById("searchBtn");
    const movieInput = document.getElementById("movieInput");

    searchBtn.addEventListener("click", buscarFilmes);

    async function buscarFilmes() {
      const movie = movieInput.value.trim();
      resultsDiv.innerHTML = "";

      if (!movie) {
        resultsDiv.innerHTML = "<p class='text-red-400'>Digite um nome válido.</p>";
        resultsDiv.classList.remove("hidden");
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/streaming?movie=${encodeURIComponent(movie)}`);

        if (!res.ok) {
          resultsDiv.innerHTML = `<p class='text-red-400'>Erro: ${res.status} ao consultar a API.</p>`;
          resultsDiv.classList.remove("hidden");
          return;
        }

        const data = await res.json();
        let filmesArray = Array.isArray(data) ? data :
                          Array.isArray(data.filmes) ? data.filmes :
                          Array.isArray(data.results) ? data.results :
                          Array.isArray(data.data) ? data.data :
                          data && typeof data === "object" ? [data] : [];

        if (filmesArray.length === 0) {
          resultsDiv.innerHTML = "<p class='text-gray-400'>Nenhum filme encontrado.</p>";
        } else {
          resultsDiv.innerHTML = "";
          filmesArray.forEach((filme, index) => {
            const title = filme.title || filme.titulo || filme.name || "Título indisponível";
            const overview = filme.overview || filme.descricao || filme.plot || "";
            const posterPath = filme.poster_path || filme.poster || filme.capa || "";
            const posterUrl = posterPath
              ? (posterPath.startsWith("http") ? posterPath : `https://image.tmdb.org/t/p/w300${posterPath}`)
              : "https://via.placeholder.com/300x450?text=Sem+Capa";

            let providersArr = Array.isArray(filme.providers) ? filme.providers :
                              Array.isArray(filme.provedores) ? filme.provedores :
                              Array.isArray(filme.providersData) ? filme.providersData : [];

            providersArr = providersArr.map(p => ({
              name: p.provider_name || p.nome || p.name || "Provedor",
              logo: p.logo_path
                ? (p.logo_path.startsWith("http") ? p.logo_path : `https://image.tmdb.org/t/p/original${p.logo_path}`)
                : (p.logo || null)
            }));

            const providersHTML = `
  <div class="flex gap-3 mt-3 flex-wrap justify-center">
    ${providersArr.map(pr => `
      <div class="flex flex-col items-center text-xs">
        ${pr.logo ? `<img src="${pr.logo}" alt="${pr.name}" class="w-10 h-10 mb-1 rounded">` : ""}
        <span class="text-sm">${pr.name}</span>
        ${pr.link ? `<a href="${pr.link}" target="_blank" class="mt-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-white text-sm">Assistir</a>` : ""}
      </div>
    `).join("")}
  </div>
`;


            const delayClass = `delay-[${index * 150}ms]`;
            const card = document.createElement("div");
            card.className = `
              bg-[#4a2c4f]/90 p-4 rounded-lg shadow flex flex-col items-center 
              w-40 sm:w-48 md:w-56 lg:w-64
              opacity-0 animate-[fadeInUp_0.8s_ease-out_forwards] 
              ${delayClass}
            `;
            card.innerHTML = `
              <img src="${posterUrl}" alt="${title}" 
                  class="w-full h-56 sm:h-64 md:h-72 lg:h-80 rounded mb-3 object-cover">
              <h2 class="text-[#f3e9ff] sm:text-lg font-semibold text-center">${title}</h2>
              <p class="text-xs sm:text-sm mt-2 text-gray-300">
                ${overview || "Sem descrição disponível."}
              </p>
              ${providersHTML}
            `;
            resultsDiv.appendChild(card);
          });
        }

        resultsDiv.classList.remove("hidden");
        mainContainer.classList.remove("justify-center");
        mainContainer.classList.add("justify-start", "pt-10");

      } catch (err) {
        resultsDiv.innerHTML = "<p class='text-red-400'>Erro ao buscar filme.</p>";
        resultsDiv.classList.remove("hidden");
      }
    }

    // Texto animado
    const frases = [
      "O que vamos ver hoje?",
      "Onde tá passando esse filme?",
      "Em qual streaming posso assistir?",
      "Qual o melhor lugar para ver?",
      "Onde posso encontrar esse filme?",
      "Qual o gênero do dia?",
      "Qual filme vamos assistir hoje?",
      "Qual o filme da vez?",
      "Qual o filme do dia?",
      "Qual o filme do final de semana?",
    ];

    let i = 0, j = 0, apagando = false;
    const speed = 80, eraseSpeed = 50, delayEntreFrases = 1800;
    const dynamicText = document.getElementById("dynamicText");

    function typeEffect() {
      const fraseAtual = frases[i];
      if (!apagando) {
        dynamicText.textContent = fraseAtual.slice(0, j + 1);
        j++;
        if (j === fraseAtual.length) {
          apagando = true;
          setTimeout(typeEffect, delayEntreFrases);
          return;
        }
      } else {
        dynamicText.textContent = fraseAtual.slice(0, j - 1);
        j--;
        if (j === 0) {
          apagando = false;
          i = (i + 1) % frases.length;
        }
      }
      setTimeout(typeEffect, apagando ? eraseSpeed : speed);
    }
    typeEffect();
  </script>

  <footer class="bg-transparent text-center text-gray-600 text-sm py-4">
    © 2025 Paulo Cesar Dolzan — Todos os direitos reservados
  </footer>
</body>
</html>
